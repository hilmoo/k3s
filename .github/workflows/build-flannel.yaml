name: Build K3s Binary

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag for the release (e.g., v1.28.1+k3s1)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    name: Build K3s Linux amd64
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    steps:
      - name: Checkout K3s
        uses: actions/checkout@v6

      - name: Set up Docker
        uses: docker/setup-docker-action@v4
        with:
          version: type=image,tag=28
          daemon-config: '{"features":{"containerd-snapshotter":true}}'
          set-host: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine Git Version Info
        id: git_vars
        run: |
          source ./scripts/git_version.sh
          {
            echo "git_tag=${GIT_TAG}"
            echo "tree_state=${TREE_STATE}"
            echo "commit=${COMMIT}"
            echo "dirty=${DIRTY}"
          } >> "$GITHUB_OUTPUT"

      - name: Build K3s Binary
        env:
          DOCKER_BUILD_SUMMARY: false
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.local
          target: result
          build-args: |
            GIT_TAG=${{ steps.git_vars.outputs.git_tag }}
            TREE_STATE=${{ steps.git_vars.outputs.tree_state }}
            COMMIT=${{ steps.git_vars.outputs.commit }}
            DIRTY=${{ steps.git_vars.outputs.dirty }}
            GOOS=linux
          push: false
          provenance: mode=min
          outputs: type=local,dest=.

      - name: Calculate binary checksum
        run: |
          sha256sum dist/artifacts/k3s | sed 's|dist/artifacts/||' > dist/artifacts/k3s.sha256sum

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version }}
          name: K3s ${{ inputs.version }}
          draft: false
          prerelease: false
          files: |
            dist/artifacts/k3s
            dist/artifacts/k3s.sha256sum
